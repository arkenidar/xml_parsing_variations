<title>pack html</title>
<meta charset="utf-8">

<div id="pack_this" style="display: none"><div class="msg">HTML text ENCODER</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div></div>

<b>statistics</b>
<div id="stats"></div>
<hr>

<b>packing results in this</b>
<div id="packed"></div>
<hr>

<b>packed from this HTML</b>
<div id="packed_from_this"></div>
<hr>

<script>

function processNodesNG(nodes){
    var subNodes=[]
    for(processedNode of nodes){
        subNodes.push(processNodeNG(processedNode))
    }
    return subNodes.join('')
}

function processNodeNG(processedNode){
    switch(processedNode.nodeType){
        case processedNode.TEXT_NODE:
            return processedNode.textContent
            break
        case processedNode.ELEMENT_NODE:
            var produced=[]
            produced.push('{'+processedNode.tagName.toLowerCase())
            var attribute_section=[]
            for(attribute of processedNode.attributes)
                attribute_section.push(attribute.nodeName+'|'+attribute.nodeValue)
            produced.push(...attribute_section)
            if(processedNode.childNodes){
                var sub=processNodesNG(processedNode.childNodes)
                if(sub!='')produced.push(sub)
            }
            return produced.join('|')+'}'
            break
    }
}

function pack(node){
    return processNodesNG(node.childNodes)
}
function $(id){
    return document.getElementById(id)
}

$('packed').innerHTML=pack($('pack_this'))
var previous_lenght= $('pack_this').innerHTML.length
var reduction=previous_lenght-$('packed').innerHTML.length

$('stats').innerHTML='reduced of '+reduction+' of '+previous_lenght+
' -- <b>'+reduction/(previous_lenght/100)+'%</b>'
$('packed_from_this').innerText=$('pack_this').innerHTML

var equivalence=$('pack_this').innerHTML==parse($('packed').innerHTML)
$('stats').innerHTML+='<div>is packed equivalent to source? <b>'+equivalence+'</b>'

//////////////////////////////////////

function parse(str){
    if(str=='') return '';
    var level=0;
    buffer='';
    for(var i=0;i<str.length;i++){
        if(level==0 && str[i]!='{' && str[i]!='}')
            buffer+=str[i];
        if(str[i]=='{'){
            if(level==0) open=i;
            level++;
        }
        if(str[i]=='}'){
            level--;
            if(level==0) {
                close=i;
                var text=str.substring(open, close+1);
                buffer+=parens(text);
            }
        }
    }
    return buffer;
}
function parens(str){
    var parts=str.substring(1);
    parts=parts.substring(0,parts.length-1);
    var buffer='';
    var array=[];
    for(var i=0; i<parts.length; i++)
    {
        if(parts[i]=='{'){
            array.push(buffer+parts.slice(i));
            buffer='';
            break;
        }
        if(parts[i]!='|'){
            buffer+=parts[i];
        }
        if(parts[i]=='|'){
            array.push(buffer);
            buffer='';
        }
        if(i==parts.length-1){
            array.push(buffer);
            buffer='';
        }
    }
    parts=array;
    var tagname=parts[0];
    parts=parts.slice(1);
    var content='';
    if((parts.length%2)==1){
        content=parts[parts.length-1];
        parts.splice(-1);
    }
    var attributes='';
    for(var i=0; i<parts.length; i+=2){
        if(parts[i+1]!='')
            attributes+=' '+parts[i]+'="'+parts[i+1]+'"';
        else
            attributes+=' '+parts[i];
    }
    var to_return='<'+tagname+attributes+'>'+parse(content)+'</'+tagname+'>';
    return to_return;
}
</script>
