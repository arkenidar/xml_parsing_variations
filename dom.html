<title>pack html</title>
<meta charset="utf-8">

<script id="pack_this" type="html"><link href="https://getbootstrap.com/docs/4.0/dist/css/bootstrap.min.css" rel="stylesheet"></link><link href="https://getbootstrap.com/docs/4.0/examples/sign-in/signin.css" rel="stylesheet"></link><form class="form-signin"><img class="mb-4" src="https://getbootstrap.com/docs/4.0/assets/brand/bootstrap-solid.svg" width="72" height="72"></img><h1 class="h3 mb-3 font-weight-normal">Please sign in</h1><label for="inputEmail" class="sr-only">Email address</label><input type="email" id="inputEmail" class="form-control" placeholder="Email address" required autofocus></input><label for="inputPassword" class="sr-only">Password</label><input type="password" id="inputPassword" class="form-control" placeholder="Password" required></input><div class="checkbox mb-3"><label><input type="checkbox" value="remember-me"></input> Remember me</label></div><button class="btn btn-lg btn-primary btn-block" type="submit">Sign in</button><p class="mt-5 mb-3 text-muted">Â© 2017-2018</p></form></script>
<b>statistics</b>
<div id="stats"></div>
<hr>
<style>
.codeview {white-space: nowrap; font-family: monospace;}
</style>
<b>packing results in this (level 2)</b>
<div id="packed2" class="codeview"></div>
<hr>
<b>packing results in this (level 1)</b>
<div id="packed1" class="codeview"></div>
<hr>

<b>packed from this HTML</b>
<div id="packed_from_this" class="codeview"></div>
<hr>

<b>reconstructed/unpacked HTML</b>
<div id="unpacked" class="codeview"></div>
<hr>

<div style="display:none" id="inject"></div>

<script>

function processDOM(nodes,dictionary){

dictOn=()=>typeof dictionary!='undefined'

function processNodes(nodes){
    var subNodes=[]
    for(processedNode of nodes){
        subNodes.push(processNode(processedNode))
    }
    return subNodes.join('')
}

function processNode(processedNode){
    
    function addToDictionary(name,type){
        if(!dictOn()) return
        if(name in dictionary[type])
            dictionary[type][name]+=name.length
        else
            dictionary[type][name]=name.length
    }

    switch(processedNode.nodeType){
        case processedNode.TEXT_NODE:
            return processedNode.textContent
            break
        case processedNode.ELEMENT_NODE:
            var produced=[]
            var tagName=processedNode.tagName.toLowerCase()
            addToDictionary(tagName,'tagName')
            produced.push('{'+tagName)
            var attribute_section=[]
            for(attribute of processedNode.attributes){
                var nodeName=attribute.nodeName
                addToDictionary(nodeName,'nodeName')
                attribute_section.push(nodeName+'|'+attribute.nodeValue)
            }
            produced.push(...attribute_section)
            if(processedNode.childNodes){
                var sub=processNodes(processedNode.childNodes)
                if(sub!='')produced.push(sub)
            }
            return produced.join('|')+'}'
            break
    }
}

var text=processNodes(nodes)
return {text,dictionary}
}

// HTML => packed
function pack(node,dictionary){
    var packed=processDOM(node.childNodes,dictionary)
    if(typeof dictionary!='undefined'){
        function processDictionary(dictionary){
            dictionary=dictSort(dictionary)
            dictionary=dictionary.map(e=>e[0])
            return dictionary   
        }
        packed.dictionary.tagName=processDictionary(packed.dictionary.tagName)
        packed.dictionary.nodeName=processDictionary(packed.dictionary.nodeName)
    }
    return packed
}

// packed => HTML
function unpack(string,codes){
    return parse(string,codes)
}

function $(id){
    return document.getElementById(id)
}

var packingResults=testPack1And2AndUnpack(
    document.createRange().createContextualFragment($('pack_this').text)
    )
$('packed1').innerText=packingResults.packed.text
$('packed2').innerText=packingResults.parsedCodes

var previousLenght= $('pack_this').innerHTML.length
var reduction=previousLenght-$('packed2').innerHTML.length

$('stats').innerHTML='reduced of '+reduction+' of '+previousLenght+
' -- <b>'+Math.round(reduction/(previousLenght/100))+'%</b>'
$('packed_from_this').innerText=$('pack_this').innerHTML

$('unpacked').innerText=packingResults.unpackedCodes
var equivalence=$('pack_this').text==packingResults.unpackedCodes
$('stats').innerHTML+='<div>is packed equivalent to source? <b>'+equivalence+'</b>'

//////////////////////////////////////

function parse(str,codes){
    if(str=='') return '';
    var level=0;
    buffer='';
    for(var i=0;i<str.length;i++){
        if(level==0 && str[i]!='{' && str[i]!='}')
            buffer+=str[i];
        if(str[i]=='{'){
            if(level==0) open=i;
            level++;
        }
        if(str[i]=='}'){
            level--;
            if(level==0) {
                close=i;
                var text=str.substring(open, close+1);
                buffer+=parens(text,codes);
            }
        }
    }
    return buffer;
}

function parens(str,codes){
    var parts=str.substring(1);
    parts=parts.substring(0,parts.length-1);
    var buffer='';
    var array=[];
    for(var i=0; i<parts.length; i++)
    {
        if(parts[i]=='{'){
            array.push(buffer+parts.slice(i));
            buffer='';
            break;
        }
        if(parts[i]!='|'){
            buffer+=parts[i];
        }
        if(parts[i]=='|'){
            array.push(buffer);
            buffer='';
        }
        if(i==parts.length-1){
            array.push(buffer);
            buffer='';
        }
    }
    parts=array;
    var tagname=codes(parts[0],'tagName');
    parts=parts.slice(1);
    var content='';
    if((parts.length%2)==1){
        content=parts[parts.length-1];
        parts.splice(-1);
    }
    var attributes='';
    for(var i=0; i<parts.length; i+=2){
        if(parts[i+1]!='')
            attributes+=' '+codes(parts[i],'nodeName')+'="'+parts[i+1]+'"';
        else
            attributes+=' '+codes(parts[i],'nodeName');
    }
    var to_return='<'+tagname+attributes+'>'+parse(content,codes)+'</'+tagname+'>';
    return to_return;
}

//////////////////////////////////////////////

function dictSort(dict){
    // create items array
    var items = Object.entries(dict)

    // sort the array based on the second element
    items.sort(function(first, second) {
        return second[1]-first[1]
    })

    return items
}

//////////////////////////////////////////////

//$('inject').innerHTML='<div class="msg">some text</div>'
//console.log(testPack1And2AndUnpack($('inject')))

function testPack1And2AndUnpack(node){
    // pack phase1
    var packed=pack(node,{tagName:{},nodeName:{}})
    // pack phase2
    var parsedCodes=parseCodes(packed.text,(code,type)=>packed.dictionary[type].indexOf(code))
    // unpack from phase2
    var unpackedCodes=unpack(parsedCodes,(i,type)=>packed.dictionary[type][i])
    return {packed,parsedCodes,unpackedCodes}
}

//////////////////////////////////////////////

function parensCodes(str,codes){
    var parts=str.substring(1);
    parts=parts.substring(0,parts.length-1);
    var buffer='';
    var array=[];
    for(var i=0; i<parts.length; i++)
    {
        if(parts[i]=='{'){
            array.push(buffer+parts.slice(i));
            buffer='';
            break;
        }
        if(parts[i]!='|'){
            buffer+=parts[i];
        }
        if(parts[i]=='|'){
            array.push(buffer);
            buffer='';
        }
        if(i==parts.length-1){
            array.push(buffer);
            buffer='';
        }
    }
    parts=array;
    var tagname=codes(parts[0],'tagName');
    parts=parts.slice(1);
    var content='';
    if((parts.length%2)==1){
        content=parts[parts.length-1];
        parts.splice(-1);
    }
    var attributes='';
    for(var i=0; i<parts.length; i+=2){
        attributes+='|'+codes(parts[i],'nodeName')+'|'+parts[i+1];
    }
    var subpart=parseCodes(content,codes);
    if(subpart!='') subpart='|'+subpart;
    var to_return='{'+tagname+attributes+subpart+'}';
    return to_return;
}

function parseCodes(str,codes){
    if(str=='') return '';
    var level=0;
    buffer='';
    for(var i=0;i<str.length;i++){
        if(level==0 && str[i]!='{' && str[i]!='}')
            buffer+=str[i];
        if(str[i]=='{'){
            if(level==0) open=i;
            level++;
        }
        if(str[i]=='}'){
            level--;
            if(level==0) {
                close=i;
                var text=str.substring(open, close+1);
                buffer+=parensCodes(text,codes);
            }
        }
    }
    return buffer;
}

</script>
