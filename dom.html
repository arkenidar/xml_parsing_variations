<title>pack html</title>
<meta charset="utf-8">

<div id="pack_this" style="display: none"><div class="msg">HTML text ENCODER</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div><div class="msg">some text</div></div>

<b>statistics</b>
<div id="stats"></div>
<hr>

<b>packing results in this</b>
<div id="packed"></div>
<hr>

<b>packed from this HTML</b>
<div id="packed_from_this"></div>
<hr>

<div style="display:none" id="inject"></div>

<script>

function processDOM(nodes,dictionary){

dictOn=()=>typeof dictionary!='undefined'

function processNodes(nodes){
    var subNodes=[]
    for(processedNode of nodes){
        subNodes.push(processNode(processedNode))
    }
    return subNodes.join('')
}

function processNode(processedNode){
    
    function addToDictionary(name){
        if(!dictOn()) return
        if(name in dictionary)
            dictionary[name]+=name.length
        else
            dictionary[name]=name.length
    }

    switch(processedNode.nodeType){
        case processedNode.TEXT_NODE:
            return processedNode.textContent
            break
        case processedNode.ELEMENT_NODE:
            var produced=[]
            var tagName=processedNode.tagName.toLowerCase()
            addToDictionary(tagName)
            produced.push('{'+tagName)
            var attribute_section=[]
            for(attribute of processedNode.attributes){
                var nodeName=attribute.nodeName
                addToDictionary(nodeName)
                attribute_section.push(nodeName+'|'+attribute.nodeValue)
            }
            produced.push(...attribute_section)
            if(processedNode.childNodes){
                var sub=processNodes(processedNode.childNodes)
                if(sub!='')produced.push(sub)
            }
            return produced.join('|')+'}'
            break
    }
}

var text=processNodes(nodes)

//if(dictOn()) console.log(dictSort(dictionary))

return {text,dictionary}
}

// HTML => packed
function pack(node,dictionary){
    var result=processDOM(node.childNodes,dictionary)
    return result
}

// packed => HTML
function unpack(string,codes){
    return parse(string,codes)
}

function $(id){
    return document.getElementById(id)
}

var packingResults=pack($('pack_this'),{})
$('packed').innerHTML=packingResults.text
console.log(dictSort(packingResults.dictionary))
var previousLenght= $('pack_this').innerHTML.length
var reduction=previousLenght-$('packed').innerHTML.length

$('stats').innerHTML='reduced of '+reduction+' of '+previousLenght+
' -- <b>'+reduction/(previousLenght/100)+'%</b>'
$('packed_from_this').innerText=$('pack_this').innerHTML

var equivalence=$('pack_this').innerHTML==unpack($('packed').innerHTML,(i)=>i)
$('stats').innerHTML+='<div>is packed equivalent to source? <b>'+equivalence+'</b>'

//////////////////////////////////////

function parse(str,codes){
    if(str=='') return '';
    var level=0;
    buffer='';
    for(var i=0;i<str.length;i++){
        if(level==0 && str[i]!='{' && str[i]!='}')
            buffer+=str[i];
        if(str[i]=='{'){
            if(level==0) open=i;
            level++;
        }
        if(str[i]=='}'){
            level--;
            if(level==0) {
                close=i;
                var text=str.substring(open, close+1);
                buffer+=parens(text,codes);
            }
        }
    }
    return buffer;
}

function parens(str,codes){
    var parts=str.substring(1);
    parts=parts.substring(0,parts.length-1);
    var buffer='';
    var array=[];
    for(var i=0; i<parts.length; i++)
    {
        if(parts[i]=='{'){
            array.push(buffer+parts.slice(i));
            buffer='';
            break;
        }
        if(parts[i]!='|'){
            buffer+=parts[i];
        }
        if(parts[i]=='|'){
            array.push(buffer);
            buffer='';
        }
        if(i==parts.length-1){
            array.push(buffer);
            buffer='';
        }
    }
    parts=array;
    var tagname=codes(parts[0]);
    parts=parts.slice(1);
    var content='';
    if((parts.length%2)==1){
        content=parts[parts.length-1];
        parts.splice(-1);
    }
    var attributes='';
    for(var i=0; i<parts.length; i+=2){
        if(parts[i+1]!='')
            attributes+=' '+codes(parts[i])+'="'+parts[i+1]+'"';
        else
            attributes+=' '+codes(parts[i]);
    }
    var to_return='<'+tagname+attributes+'>'+parse(content,codes)+'</'+tagname+'>';
    return to_return;
}


/*
var dict = {
  "x": 1,
  "y": 6,
  "z": 9,
  "a": 5,
  "b": 7,
  "c": 11,
  "d": 17,
  "t": 3
};
console.log(dictSort(dict))
*/
function dictSort(dict){
    // create items array
    var items = Object.entries(dict)

    // sort the array based on the second element
    items.sort(function(first, second) {
        return second[1]-first[1]
    })

    return items
}
var html='<div class="msg">some text</div>'
$('inject').innerHTML=html
var packed=pack($('inject'),{})
packed.dictionary=dictSort(packed.dictionary)
packed.dictionary=packed.dictionary.map(e=>e[0])
//console.log('sort',dictSort(packed.dictionary))
console.log(packed)
var dict=packed.dictionary//['class','div']
var packed1=packed.text//'{div|class|msg|some text}'
console.log(unpack(packed1,i=>i))
codes=(code)=>dict.indexOf(code)
//
var parsedCodes=parseCodes(packed1)
console.log(parsedCodes)
var unpackedCodes=unpack(parsedCodes,i=>dict[i])
console.log('original html',unpackedCodes)
console.log('equality with original html', unpackedCodes==html)

function parensCodes(str){
    var parts=str.substring(1);
    parts=parts.substring(0,parts.length-1);
    var buffer='';
    var array=[];
    for(var i=0; i<parts.length; i++)
    {
        if(parts[i]=='{'){
            array.push(buffer+parts.slice(i));
            buffer='';
            break;
        }
        if(parts[i]!='|'){
            buffer+=parts[i];
        }
        if(parts[i]=='|'){
            array.push(buffer);
            buffer='';
        }
        if(i==parts.length-1){
            array.push(buffer);
            buffer='';
        }
    }
    parts=array;
    var tagname=codes(parts[0]);
    parts=parts.slice(1);
    var content='';
    if((parts.length%2)==1){
        content=parts[parts.length-1];
        parts.splice(-1);
    }
    var attributes='';
    for(var i=0; i<parts.length; i+=2){
        attributes+='|'+codes(parts[i])+'|'+parts[i+1];
    }
    var subpart=parseCodes(content);
    if(subpart!='') subpart='|'+subpart;
    var to_return='{'+tagname+attributes+subpart+'}';
    return to_return;
}

function parseCodes(str){
    if(str=='') return '';
    var level=0;
    buffer='';
    for(var i=0;i<str.length;i++){
        if(level==0 && str[i]!='{' && str[i]!='}')
            buffer+=str[i];
        if(str[i]=='{'){
            if(level==0) open=i;
            level++;
        }
        if(str[i]=='}'){
            level--;
            if(level==0) {
                close=i;
                var text=str.substring(open, close+1);
                buffer+=parensCodes(text);
            }
        }
    }
    return buffer;
}

</script>
